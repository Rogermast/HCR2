<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horario de Clases R2</title>
    
    <!-- ================================================== -->
    <!--               LIBRER√çAS EXTERNAS                  -->
    <!-- ================================================== -->
    <!-- Librer√≠a para manejar archivos Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- Librer√≠a para crear y descargar archivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- ================================================== -->
    <!--                   ESTILOS CSS                      -->
    <!-- ================================================== -->
    <style>
        /* Estilos Generales */
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        /* Cabecera */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .info-colegio {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .info-colegio input {
            padding: 10px 15px;
            border: 1px solid #555;
            border-radius: 25px;
            font-size: 1em;
            background-color: #34495e;
            color: white;
            width: 250px;
            text-align: center;
        }

        .info-colegio input::placeholder {
            color: #bdc3c7;
        }

        /* Panel de Control */
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background-color: #ecf0f1;
            flex-wrap: wrap;
        }

        button, .btn-file {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover, .btn-file:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        button#modo-edicion {
            background-color: #e67e22;
        }
        button#modo-edicion:hover {
            background-color: #d35400;
        }
        button#modo-edicion.active {
            background-color: #c0392b;
        }

        .btn-file {
            display: inline-block;
            text-decoration: none;
        }
        #cargar-excel {
            display: none;
        }

        /* Tabla de Horario */
        main {
            padding: 20px 40px 40px 40px;
        }

        #horario-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
        }

        #horario-table th, #horario-table td {
            border: 1px solid #bdc3c7;
            padding: 15px 10px;
            text-align: center;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
        }

        #horario-table th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        #horario-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        #horario-table td.celda-materia {
            cursor: pointer;
            font-weight: 500;
            position: relative;
        }

        #horario-table td.celda-materia:hover {
            background-color: #d5dbdd;
            transform: scale(1.03);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #horario-table td.descanso, #horario-table td.alimentaci√≥n, #horario-table td.salida {
            background-color: #e0e0e0;
            color: #666;
            font-style: italic;
            cursor: default;
        }

        /* Estilos para celda con tarea */
        .tarea-asignada {
            background-color: #fadbd8 !important; /* Rojo claro */
            color: #922b21;
            font-weight: bold;
        }

        .tarea-asignada::after {
            content: 'T';
            position: absolute;
            top: 3px;
            right: 5px;
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1em;
        }

        /* Estilos para el modo de edici√≥n */
        #horario-table td.editable {
            background-color: #fffbe6;
            cursor: text;
        }

        /* Modal (Ventana Emergente) Gen√©rica */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: none;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            animation: slideIn 0.4s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close, .close-full-img {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover, .close-full-img:hover, .close:focus, .close-full-img:focus {
            color: #000;
            text-decoration: none;
        }

        #texto-tarea {
            width: 100%;
            height: 120px;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 1em;
            box-sizing: border-box;
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-danger {
            background-color: #e74c3c !important;
        }
        .btn-danger:hover {
            background-color: #c0392b !important;
        }

        /* Estilos para las funcionalidades avanzadas */
        .advanced-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .advanced-actions button {
            flex-grow: 1;
            background-color: #9b59b6; /* P√∫rpura */
        }
        .advanced-actions button:hover {
            background-color: #8e44ad;
        }
        #imagen-preview-container {
            margin-top: 15px;
            text-align: center;
        }
        #imagen-capturada {
            max-width: 150px;
            max-height: 150px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #imagen-capturada:hover {
            transform: scale(1.05);
        }

        /* Modal para imagen a pantalla completa */
        .modal-content-full-img {
            margin: 2% auto;
            padding: 20px;
            width: 95%;
            max-width: 900px;
            background-color: transparent;
            box-shadow: none;
        }
        #imagen-ampliada {
            width: 100%;
            border-radius: 8px;
        }

        /* Estilos para el Modal de la C√°mara */
        #camera-modal .modal-content {
            max-width: 700px;
            text-align: center;
        }
        #camera-select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
        }
        #video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border-radius: 8px;
            background-color: #000;
        }
        #canvas {
            display: none;
        }
        .camera-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .camera-actions button {
            padding: 15px 25px;
            font-size: 1.1em;
        }
        #capture-btn {
            background-color: #2ecc71;
        }
        #capture-btn:hover {
            background-color: #27ae60;
        }
        #cancel-camera-btn {
            background-color: #e74c3c;
        }
        #cancel-camera-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>

    <!-- ================================================== -->
    <!--               ESTRUCTURA HTML                     -->
    <!-- ================================================== -->
    <div class="container">
        <header>
            <h1>Horario de Clases R2</h1>
            <div class="info-colegio">
                <input type="text" id="nombre-colegio" placeholder="Nombre del Colegio">
                <input type="text" id="director-grupo" placeholder="Director de Grupo">
                <input type="text" id="grado-estudio" placeholder="Grado de Estudio">
            </div>
        </header>

        <main>
            <!-- Panel de Control -->
            <div class="control-panel">
                <button id="modo-edicion">‚úèÔ∏è Modificar Materias</button>
                <label for="cargar-excel" class="btn-file">üìÇ Cargar Horario desde Excel</label>
                <input type="file" id="cargar-excel" accept=".xlsx, .xls">
            </div>

            <!-- La tabla del horario se genera aqu√≠ con JavaScript -->
            <table id="horario-table"></table>
        </main>
    </div>

    <!-- Ventana emergente para gestionar tareas -->
    <div id="tarea-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üìù Gestionar Tarea</h2>
            <p><strong>Materia:</strong> <span id="materia-seleccionada"></span></p>
            
            <textarea id="texto-tarea" placeholder="Describe la tarea aqu√≠..."></textarea>

            <!-- Botones de acci√≥n avanzada -->
            <div class="advanced-actions">
                <button id="capturar-imagen-btn">üì∏ Tomar Foto con la C√°mara</button>
                <button id="grabar-audio-btn" style="display:none;">üé§ Grabar Audio (Mant√©n Presionado)</button>
            </div>
            
            <!-- Vista previa de la imagen capturada -->
            <div id="imagen-preview-container" style="display: none;">
                <p><strong>Imagen Capturada:</strong></p>
                <img id="imagen-capturada" src="#" alt="Captura de pantalla de la tarea" title="Click para ampliar">
            </div>

            <div class="modal-actions">
                <button id="guardar-tarea">üíæ Guardar Todo</button>
                <button id="descargar-info-btn">üì¶ Descargar Info R2</button>
                <button id="eliminar-tarea" class="btn-danger">üóëÔ∏è Eliminar Tarea</button>
            </div>
        </div>
    </div>

    <!-- Modal para ver la imagen a tama√±o completo -->
    <div id="imagen-modal" class="modal">
        <div class="modal-content-full-img">
            <span class="close-full-img">&times;</span>
            <img id="imagen-ampliada" src="#" alt="Imagen ampliada">
        </div>
    </div>

    <!-- Modal para la c√°mara -->
    <div id="camera-modal" class="modal">
        <div class="modal-content">
            <h2>üì∏ C√°mara de Tarea</h2>
            <select id="camera-select"></select>
            <video id="video" autoplay></video>
            <canvas id="canvas"></canvas>
            <div class="camera-actions">
                <button id="capture-btn">üì∑ Capturar Foto</button>
                <button id="cancel-camera-btn" class="btn-danger">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- ================================================== -->
    <!--                   L√ìGICA JAVASCRIPT                -->
    <!-- ================================================== -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENTOS DEL DOM ---
        const horarioTable = document.getElementById('horario-table');
        const tareaModal = document.getElementById('tarea-modal');
        const imagenModal = document.getElementById('imagen-modal');
        const cameraModal = document.getElementById('camera-modal');
        const spanClose = document.getElementsByClassName('close')[0];
        const spanCloseFullImg = document.getElementsByClassName('close-full-img')[0];
        const materiaSeleccionadaSpan = document.getElementById('materia-seleccionada');
        const textoTareaTextarea = document.getElementById('texto-tarea');
        const guardarTareaBtn = document.getElementById('guardar-tarea');
        const eliminarTareaBtn = document.getElementById('eliminar-tarea');
        const descargarInfoBtn = document.getElementById('descargar-info-btn');

        const modoEdicionBtn = document.getElementById('modo-edicion');
        const cargarExcelInput = document.getElementById('cargar-excel');
        
        // Nuevos elementos para imagen y audio
        const capturarImagenBtn = document.getElementById('capturar-imagen-btn');
        const grabarAudioBtn = document.getElementById('grabar-audio-btn');
        const imagenPreviewContainer = document.getElementById('imagen-preview-container');
        const imagenCapturada = document.getElementById('imagen-capturada');
        const imagenAmpliada = document.getElementById('imagen-ampliada');

        // Elementos para la c√°mara
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const cameraSelect = document.getElementById('camera-select');
        const captureBtn = document.getElementById('capture-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');

        // --- VARIABLES DE ESTADO ---
        let celdaActual = null;
        let modoEdicionActivo = false;
        let reconocimientoVoz = null;
        let stream = null; // Para detener la c√°mara

        // --- ESTRUCTURA DE DATOS INICIAL ---
        const horarioDataDefecto = [
            { hora: '7:00 - 8:00', lunes: 'Ed. F√≠sica', martes: 'Sociales', miercoles: 'Matem√°ticas', jueves: 'Biolog√≠a', viernes: 'Matematicas' },
            { hora: '8:00 - 8:50', lunes: 'Ingles', martes: 'Sociales', miercoles: 'Matematicas', jueves: 'Biologia', viernes: 'Espa√±ol' },
            { hora: '8:50 - 9:40', lunes: 'Biolog√≠a', martes: 'Religion', miercoles: 'Ingles', jueves: 'Administracion', viernes: 'Ingles' },
            { hora: '10:00 - 10:50', lunes: 'Frances', martes: 'Ptoyecto', miercoles: 'Sistemas', jueves: 'Estadistica', viernes: 'Frances' },
            { hora: '10:50 - 11:40', lunes: 'Matematicas', martes: 'Espa√±ol', miercoles: 'Sistemas', jueves: 'Plan Lector', viernes: 'Arte' },
            { hora: '12:00 - 12:50', lunes: 'Espa√±ol', martes: 'Ed. Espa√±ol', miercoles: 'Etica', jueves: 'Contabilidad', viernes: 'Contabilidad' },
            { hora: '12:50 - 1:40', lunes: 'Robotica', martes: 'Catedra', miercoles: 'Sociales', jueves: 'Filosofia', viernes: 'Ed. Fisica' },
                      
        ];
        let horarioConTareas = JSON.parse(localStorage.getItem('horarioData')) || horarioDataDefecto;

        // --- FUNCIONES PRINCIPALES ---
        function renderHorario() {
            horarioTable.innerHTML = '';
            const headerRow = horarioTable.insertRow();
            headerRow.insertCell().outerHTML = '<th>Hora</th>';
            ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'].forEach(dia => {
                headerRow.insertCell().outerHTML = `<th>${dia}</th>`;
            });
            horarioConTareas.forEach(fila => {
                const row = horarioTable.insertRow();
                row.insertCell().textContent = fila.hora;
                ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'].forEach(dia => {
                    const cell = row.insertCell();
                    const materia = fila[dia];
                    const lowerMateria = materia.toLowerCase();
                    if (['descanso', 'salida', 'alimentaci√≥n'].includes(lowerMateria)) {
                        cell.textContent = materia; cell.classList.add(lowerMateria);
                    } else {
                        cell.textContent = materia; cell.classList.add('celda-materia');
                        cell.dataset.dia = dia; cell.dataset.hora = fila.hora;
                        if (fila.tarea && fila.tarea.dia === dia) {
                            cell.classList.add('tarea-asignada');
                            let titleText = `Tarea: ${fila.tarea.descripcion || ''}`;
                            if(fila.tarea.imagenBase64) titleText += '\n(Contiene imagen)';
                            if(fila.tarea.audioTranscrito) titleText += '\n(Contiene nota de audio)';
                            cell.title = titleText;
                        }
                        cell.addEventListener('click', handleCellClick);
                    }
                });
            });
        }

        function handleCellClick(e) {
            if (modoEdicionActivo) return;
            celdaActual = e.target;
            const materia = celdaActual.textContent;
            materiaSeleccionadaSpan.textContent = materia;
            
            const dia = celdaActual.dataset.dia;
            const hora = celdaActual.dataset.hora;
            const filaData = horarioConTareas.find(f => f.hora === hora);
            const tareaActual = filaData ? filaData.tarea : null;

            textoTareaTextarea.value = tareaActual ? (tareaActual.descripcion || '') : '';
            
            if (tareaActual && tareaActual.imagenBase64) {
                imagenCapturada.src = tareaActual.imagenBase64;
                imagenPreviewContainer.style.display = 'block';
            } else {
                imagenPreviewContainer.style.display = 'none';
            }

            tareaModal.style.display = 'block';
        }

        // --- MANEJO DE EVENTOS ---
        spanClose.onclick = () => tareaModal.style.display = 'none';
        spanCloseFullImg.onclick = () => imagenModal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == tareaModal) tareaModal.style.display = 'none';
            if (event.target == imagenModal) imagenModal.style.display = 'none';
            if (event.target == cameraModal) detenerCamara();
        };

        guardarTareaBtn.onclick = () => {
            if (!celdaActual) return;
            const dia = celdaActual.dataset.dia; const hora = celdaActual.dataset.hora;
            const filaData = horarioConTareas.find(f => f.hora === hora);
            if (filaData) {
                const descripcion = textoTareaTextarea.value.trim();
                if (!descripcion && !imagenCapturada.src) {
                    alert('Debes a√±adir una descripci√≥n de texto o una imagen.');
                    return;
                }
                if (!filaData.tarea) filaData.tarea = { dia, hora };
                filaData.tarea.descripcion = descripcion;
                localStorage.setItem('horarioData', JSON.stringify(horarioConTareas));
                renderHorario();
                tareaModal.style.display = 'none';
            }
        };
        
        eliminarTareaBtn.onclick = () => {
            if (!celdaActual) return;
            const dia = celdaActual.dataset.dia; const hora = celdaActual.dataset.hora;
            const filaData = horarioConTareas.find(f => f.hora === hora);
            if (filaData && filaData.tarea) {
                delete filaData.tarea;
                localStorage.setItem('horarioData', JSON.stringify(horarioConTareas));
                renderHorario();
                tareaModal.style.display = 'none';
            }
        };

        // --- FUNCIONALIDAD DE C√ÅMARA CON SELECCI√ìN ---
        capturarImagenBtn.onclick = iniciarCamara;
        cancelCameraBtn.onclick = detenerCamara;
        captureBtn.onclick = tomarFoto;
        cameraSelect.onchange = () => iniciarStream(cameraSelect.value);

        async function iniciarCamara() {
            cameraModal.style.display = 'block';
            await listarCamaras();
            iniciarStream(cameraSelect.value);
        }

        async function listarCamaras() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            cameraSelect.innerHTML = ''; // Limpiar opciones existentes
            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                const label = device.label || `C√°mara ${index + 1}`;
                option.text = label;
                cameraSelect.appendChild(option);
            });
        }

        async function iniciarStream(deviceId) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined
                }
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
            } catch (err) {
                console.error("Error al acceder a la c√°mara: ", err);
                alert("No se pudo acceder a la c√°mara seleccionada. Intenta con otra.");
            }
        }

        function detenerCamara() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                stream = null;
            }
            cameraModal.style.display = 'none';
        }

        function tomarFoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imagenBase64 = canvas.toDataURL('image/png');
            imagenCapturada.src = imagenBase64;
            imagenPreviewContainer.style.display = 'block';

            if(celdaActual) {
                const dia = celdaActual.dataset.dia; const hora = celdaActual.dataset.hora;
                const filaData = horarioConTareas.find(f => f.hora === hora);
                if(filaData) {
                    if (!filaData.tarea) filaData.tarea = { dia, hora };
                    filaData.tarea.imagenBase64 = imagenBase64;
                    localStorage.setItem('horarioData', JSON.stringify(horarioConTareas));
                }
            }
            
            detenerCamara();
            alert('¬°Foto capturada y guardada en la tarea!');
        }

        imagenCapturada.onclick = () => {
            imagenAmpliada.src = imagenCapturada.src;
            imagenModal.style.display = 'block';
        };

        // --- FUNCIONALIDAD DE AUDIO (Sin cambios) ---
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            reconocimientoVoz = new SpeechRecognition();
            reconocimientoVoz.lang = 'es-ES';
            reconocimientoVoz.interimResults = false;
            reconocimientoVoz.maxAlternatives = 1;
            reconocimientoVoz.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                textoTareaTextarea.value += (textoTareaTextarea.value ? ' ' : '') + transcript;
            };
            reconocimientoVoz.onerror = (event) => {
                console.error('Error en el reconocimiento de voz:', event.error);
                alert('No se pudo reconocer el audio. Intenta de nuevo.');
            };
            grabarAudioBtn.style.display = 'inline-block';
        }
        
        grabarAudioBtn.addEventListener('mousedown', iniciarGrabacion);
        grabarAudioBtn.addEventListener('mouseup', detenerGrabacion);
        grabarAudioBtn.addEventListener('touchstart', iniciarGrabacion);
        grabarAudioBtn.addEventListener('touchend', detenerGrabacion);

        function iniciarGrabacion() {
            if (!reconocimientoVoz) { alert('Tu navegador no soporta grabaci√≥n de audio.'); return; }
            grabarAudioBtn.textContent = 'üî¥ Grabando... Suelta para parar';
            grabarAudioBtn.style.backgroundColor = '#e74c3c';
            reconocimientoVoz.start();
        }

        function detenerGrabacion() {
            if (!reconocimientoVoz) return;
            grabarAudioBtn.textContent = 'üé§ Grabar Audio (Mant√©n Presionado)';
            grabarAudioBtn.style.backgroundColor = '#9b59b6';
            reconocimientoVoz.stop();
        }

        // --- FUNCI√ìN DE DESCARGA CORREGIDA ---
        descargarInfoBtn.onclick = async () => {
            if (!celdaActual) return;
            const dia = celdaActual.dataset.dia; const hora = celdaActual.dataset.hora;
            const filaData = horarioConTareas.find(f => f.hora === hora);
            const tarea = filaData ? filaData.tarea : null;

            if (!tarea) {
                alert('No hay informaci√≥n de tarea para descargar.');
                return;
            }

            const zip = new JSZip();
            const materia = celdaActual.textContent;
            
            let contenidoTexto = `Tarea para: ${materia}\nHora: ${hora}\n\n`;
            contenidoTexto += `Descripci√≥n:\n${tarea.descripcion || 'No a√±adida.'}\n\n`;
            contenidoTexto += `Nota de Audio (transcripci√≥n):\n${tarea.audioTranscrito || 'No grabada.'}`;
            zip.file(`tarea_${materia.replace(/\s+/g, '_')}.txt`, contenidoTexto);

            if (tarea.imagenBase64) {
                const base64Data = tarea.imagenBase64.split(',')[1];
                zip.file(`captura_${materia.replace(/\s+/g, '_')}.png`, base64Data, { base64: true });
            }

            try {
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `info_r2_${materia.replace(/\s+/g, '_')}.zip`;
                document.body.appendChild(a);
                a.click();
                
                // Limpieza
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                alert('Descarga iniciada. Revisa tu carpeta de Descargas.');

            } catch (error) {
                console.error('Error al generar el archivo ZIP:', error);
                alert('Ocurri√≥ un error al crear el archivo para descargar.');
            }
        };

        // --- FUNCIONES EXISTENTES (MODO EDICI√ìN Y CARGAR EXCEL) ---
        modoEdicionBtn.onclick = () => {
            modoEdicionActivo = !modoEdicionActivo;
            if (modoEdicionActivo) {
                modoEdicionBtn.textContent = 'üíæ Guardar Cambios'; modoEdicionBtn.classList.add('active');
                document.querySelectorAll('.celda-materia').forEach(celda => { celda.contentEditable = true; celda.classList.add('editable'); celda.addEventListener('blur', actualizarMateria); });
            } else {
                modoEdicionBtn.textContent = '‚úèÔ∏è Modificar Materias'; modoEdicionBtn.classList.remove('active');
                renderHorario();
            }
        };
        function actualizarMateria(e) { if (!modoEdicionActivo) return; const nuevaMateria = e.target.textContent.trim(); const dia = e.target.dataset.dia; const hora = e.target.dataset.hora; const filaData = horarioConTareas.find(f => f.hora === hora); if (filaData) { filaData[dia] = nuevaMateria; localStorage.setItem('horarioData', JSON.stringify(horarioConTareas)); } }
        cargarExcelInput.onchange = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const data = new Uint8Array(event.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); const headerIndex = jsonData.findIndex(row => row[0] && row[0].toString().toLowerCase().includes('hora')); if (headerIndex === -1) throw new Error("Formato de Excel inv√°lido."); const newHorarioData = []; for (let i = headerIndex + 1; i < jsonData.length; i++) { const row = jsonData[i]; if (row && row[0]) { newHorarioData.push({ hora: row[0], lunes: row[1] || '', martes: row[2] || '', miercoles: row[3] || '', jueves: row[4] || '', viernes: row[5] || '' }); } } horarioConTareas = newHorarioData; localStorage.setItem('horarioData', JSON.stringify(horarioConTareas)); renderHorario(); alert('¬°Horario cargado!'); } catch (error) { alert('Error al leer el archivo: ' + error.message); } }; reader.readAsArrayBuffer(file); e.target.value = ''; };

        // --- INICIALIZACI√ìN ---
        function inicializar() {
            renderHorario();
            document.getElementById('nombre-colegio').value = localStorage.getItem('nombreColegio') || '';
            document.getElementById('director-grupo').value = localStorage.getItem('directorGrupo') || '';
            document.getElementById('grado-estudio').value = localStorage.getItem('gradoEstudio') || '';
            document.getElementById('nombre-colegio').addEventListener('input', (e) => localStorage.setItem('nombreColegio', e.target.value));
            document.getElementById('director-grupo').addEventListener('input', (e) => localStorage.setItem('directorGrupo', e.target.value));
            document.getElementById('grado-estudio').addEventListener('input', (e) => localStorage.setItem('gradoEstudio', e.target.value));
        }
        inicializar();
    });
    </script>
</body>
</html>
